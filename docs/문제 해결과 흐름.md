## 2023-10-15

일단 데이터베이스로 `firestore` 사용할 것이니, `firestore` 연동하는 것부터 해야겠다.
`firestore` 연동하는 방법은 다른 데이터베이스에 비해 꽤 간단하다.

일단

```bash
npm init
npm install firebase
```

로 `firebase` 패키지를 설치한다. 그런 다음, `firebase.js` 파일을 만들자. 여기에다가
`firebase`를 초기화하는 코드를 작성할 것이다.

```js
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

const firebaseConfig = {
  apiKey: "AIzaSyDXT1hZqqhARm1-z_vR-apuESZSEIipBgc",
  authDomain: "practice-e00a8.firebaseapp.com",
  projectId: "practice-e00a8",
  storageBucket: "practice-e00a8.appspot.com",
  messagingSenderId: "725448911246",
  appId: "1:725448911246:web:55019e69d4599e5e649cdf",
  measurementId: "G-3F8M0H1NG6",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
```

이게 기본인데, 나는 `firestore sdk`를 사용할 것이기 때문에, `firestore sdk`를 추가해주자.

```js
import * as firestore from "firebase/firestore";
// ...
const db = firestore.getFirestore(app);
```

이제 `firestore`로 내 db에 접근할 수 있다. 테스트로 데이터 하나 넣어보자.

```js
firestore.addDoc(firestore.collection(db, "users"), {
  first: "Ada",
  last: "Lovelace",
  born: 1815,
});
```

오류가 발생했다.

```
[2023-10-15T03:56:51.275Z]  @firebase/analytics: Analytics: Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: (1) Cookies are not available. (analytics/invalid-analytics-context).
file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:177
    if (Array.isArray(window[dataLayerName])) {
                      ^

ReferenceError: window is not defined
    at getOrCreateDataLayer (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:177:23)
    at factory (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:1038:9)
    at Component.instanceFactory (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:1245:16)
    at Provider.getOrInitializeService (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/component/dist/esm/index.esm2017.js:290:39)
    at Provider.initialize (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/component/dist/esm/index.esm2017.js:234:31)
    at initializeAnalytics (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:1087:49)
    at getAnalytics (file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/node_modules/@firebase/analytics/dist/esm/index.esm2017.js:1066:12)
    at file:///C:/Users/gusck/node.js%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/practice/nton-video-chat/firebase.js:16:19
    at ModuleJob.run (node:internal/modules/esm/module_job:194:25)

```

`파이어베이스 분석`은 웹브라우저 환경에서만 가능하다고 나와있다. 따라서 지금은 노드 환경이니까 window가 없다고 에러를 던지는 것 같다. 그러므로 분석을 끄고 한번 더 실행해보자.

```js
import { getAnalytics } from "firebase/analytics";
const analytics = getAnalytics(app);
```

이 두 부분을 firebase.js 파일에서 제거해주자.

성공!

![Alt text](./image.png)

데이터가 잘 들어가는 모습이다.

다음으로 해야할 것은 이제 express 환경을 세팅하고 socket.io를 연동하자.

## 2023-10-16

express 환경 세팅은 또 많이 해봤으므로, 금방 하고 socket.io를 연동해야겠다.
`app.js`를 엔트리 파일로 하고 세팅을 하겠다. 관련 페키지를 설치하고 코드를 상투적으로 작성하면 되겠다.

```bash
npm install express express-session morgan cookie-parser
```

이후 평범하게 `app.js`를 작성하였다.

```js
import express from "express";
import morgan from "morgan";
import session from "express-session";
import cookieParser from "cookie-parser";

const app = express();

app.set("port", process.env.PORT || 3000);

app.use(morgan("dev"));
app.use(express.static("public"));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser(process.env.COOKIE_SECRET));
app.use(
  session({
    resave: false,
    saveUninitialized: false,
    secret: "secret",
    cookie: {
      httpOnly: true,
    },
  })
);

const server = app.listen(app.get("port"), () => {
  console.log(app.get("port"), "번 포트에서 대기중");
});
```

여기에 socket.io를 연동하면 된다. 이제 socket.io를 설치하고 express 서버와 연동하자.

```bash
npm install socket.io
```

socket.io 서버는 `socket.js` 파일에서 관리할 것이다. 파일을 만들고 거기에 기본적인 코드를 작성하겠다.

```js
// socket.js
import * as SocketIO from "socket.io";
import { firestore, db } from "./firebase.js";

const webSocket = (server, app) => {
  const io = new SocketIO.Server(server, { path: "/socket.io" });
  app.set("io", io);

  io.on("connection", (socket) => {
    console.log("새로운 클라이언트 접속", socket.id);

    socket.on("createRoom", async () => {
      console.log("createRoom event received");

      const roomRef = await firestore.addDoc(firestore.collection(db, "rooms"), {});
      console.log("방 생성", roomRef.id);
      socket.join(roomRef.id);
      console.log(`${socket.id}는 ${roomRef.id}에 입장`);
    });

    socket.on("disconnect", () => {
      console.log("클라이언트 접속 해제", socket.id);
    });
  });
};

export default webSocket;
```

```js
// app.js
const server = app.listen(app.get("port"), () => {
  console.log(app.get("port"), "번 포트에서 대기중");
});

webSocket(server, app);
```

간단하게 express 서버와, socket.io 서버를 연동했다.

이후 해야할 것은, socket.io를 위한 클라이언트 html 페이지를 작성하고, 거기에
webRTC 코드를 작성해서, 일단 1:1 화상 통신이 되게 하는 것이 목표이다.

이후, n:n 화상 통신이 되게 하자. 크게 어렵진 않을 것이다.
